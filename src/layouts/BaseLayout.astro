---
import '../styles/global.css';
import LanguageSwitcher from '../components/LanguageSwitcher.astro';
import { getLangFromUrl } from '../i18n/utils';
import { ui } from '../i18n/ui';
import type { CollectionEntry } from 'astro:content';

interface Props {
  title: string;
  description?: string;
  entryId?: string;
  allPosts?: CollectionEntry<'blog'>[];
}

const { title, description = 'Blog personal de Ramon Freire sobre TypeScript, IoT, Programación y Linux', entryId, allPosts } = Astro.props;
const lang = getLangFromUrl(Astro.url);

// Generate hreflang URLs for current page
const currentPath = Astro.url.pathname;
const pathParts = currentPath.split('/').filter(p => p);

// Remove language prefix if present
if (pathParts.length > 0 && pathParts[0] in ui) {
  pathParts.shift();
}

const basePath = pathParts.length > 0 ? '/' + pathParts.join('/') : '';
const siteUrl = Astro.site?.toString().replace(/\/$/, '') || 'https://freiredev.com';

// Generate alternate URLs for all languages
const alternateUrls = Object.keys(ui).map(langCode => ({
  lang: langCode,
  url: `${siteUrl}/${langCode}${basePath}`
}));
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <meta name="generator" content={Astro.generator} />

    <!-- Hreflang tags for SEO -->
    {alternateUrls.map(({ lang: altLang, url }) => (
      <link rel="alternate" hreflang={altLang} href={url} />
    ))}
    <link rel="alternate" hreflang="x-default" href={`${siteUrl}/es${basePath}`} />

    <title>{title}</title>
  </head>
  <body>
    <canvas id="tron-grid" class="tron-grid-canvas"></canvas>
    <div class="scanlines"></div>

    <header class="header-tron">
      <div class="header-glow"></div>
      <nav class="nav-container">
        <a href="/" class="logo" id="logo-link">
          <span class="logo-dollar">$</span>
          <span class="logo-bracket-left">{'{'}</span>
          <span class="logo-text">FREIRE.DEV</span>
          <span class="logo-bracket-right">{'}'}</span>
        </a>

        <!-- Hamburguesa (solo móvil) -->
        <button class="hamburger" id="hamburger" aria-label="Menú">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>

        <!-- Nav links (desktop) -->
        <div class="nav-links">
          <a href={`/${lang}`} class="nav-link">INICIO</a>
          <a href={`/${lang}/blog`} class="nav-link">BLOG</a>
          <a href={`/${lang}/categorias`} class="nav-link">CATEGORÍAS</a>
          <div class="controls-grid">
            <LanguageSwitcher entryId={entryId} allPosts={allPosts} />
            <label class="theme-switch">
              <input type="checkbox" id="theme-toggle" />
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </nav>

      <!-- Menú móvil overlay -->
      <div class="mobile-menu" id="mobile-menu">
        <div class="mobile-menu-content">
          <a href={`/${lang}`} class="mobile-link">INICIO</a>
          <a href={`/${lang}/blog`} class="mobile-link">BLOG</a>
          <a href={`/${lang}/categorias`} class="mobile-link">CATEGORÍAS</a>
          <div class="mobile-controls-wrapper">
            <div class="mobile-lang-switch">
              <span class="lang-label">IDIOMA</span>
              <LanguageSwitcher entryId={entryId} allPosts={allPosts} />
            </div>
            <div class="mobile-theme-switch">
              <span class="theme-label">TEMA</span>
              <label class="theme-switch">
                <input type="checkbox" id="theme-toggle-mobile" />
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="main-content">
      <slot />
    </main>

    <footer class="footer-tron">
      <div class="footer-line"></div>
      <div class="footer-content">
        <p class="footer-text">
          <span class="footer-bracket">&lt;</span>
          © {new Date().getFullYear()} RAMON FREIRE
          <span class="footer-dot">•</span>
          FREIREDEV
          <span class="footer-bracket">/&gt;</span>
        </p>
        <p class="footer-subtext">POWERED BY ASTRO</p>
      </div>
    </footer>

    <script>
      // Navbar shrink on scroll
      const header = document.querySelector('.header-tron');

      window.addEventListener('scroll', () => {
        const currentScroll = window.pageYOffset;

        if (currentScroll > 50) {
          header?.classList.add('scrolled');
        } else {
          header?.classList.remove('scrolled');
        }
      });

      // Hamburger menu
      const hamburger = document.getElementById('hamburger');
      const mobileMenu = document.getElementById('mobile-menu');
      const body = document.body;

      hamburger?.addEventListener('click', () => {
        hamburger.classList.toggle('active');
        mobileMenu?.classList.toggle('active');
        body.classList.toggle('menu-open');
      });

      // Cerrar menú al hacer click en un link
      const mobileLinks = document.querySelectorAll('.mobile-link');
      mobileLinks.forEach(link => {
        link.addEventListener('click', () => {
          hamburger?.classList.remove('active');
          mobileMenu?.classList.remove('active');
          body.classList.remove('menu-open');
        });
      });

      // Theme toggle (desktop)
      const themeToggle = document.getElementById('theme-toggle');
      const themeToggleMobile = document.getElementById('theme-toggle-mobile');
      const root = document.documentElement;

      // Cargar tema guardado
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'light') {
        root.classList.add('light-mode');
        if (themeToggle) {
          (themeToggle as HTMLInputElement).checked = true;
        }
        if (themeToggleMobile) {
          (themeToggleMobile as HTMLInputElement).checked = true;
        }
      }

      // Función para cambiar tema
      function toggleTheme(checked: boolean) {
        if (checked) {
          root.classList.add('light-mode');
          localStorage.setItem('theme', 'light');
        } else {
          root.classList.remove('light-mode');
          localStorage.setItem('theme', 'dark');
        }
        // Sincronizar ambos toggles
        if (themeToggle) (themeToggle as HTMLInputElement).checked = checked;
        if (themeToggleMobile) (themeToggleMobile as HTMLInputElement).checked = checked;
      }

      // Cambiar tema (desktop)
      themeToggle?.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        toggleTheme(target.checked);
      });

      // Cambiar tema (mobile)
      themeToggleMobile?.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        toggleTheme(target.checked);
      });

      // Logo link: redirect to preferred language
      const logoLink = document.getElementById('logo-link');
      logoLink?.addEventListener('click', (e) => {
        e.preventDefault();
        const savedLang = localStorage.getItem('preferred-language');
        const targetLang = savedLang || 'es';
        window.location.href = `/${targetLang}`;
      });
    </script>

    <script>
      import { initTronGrid } from '../scripts/tron-grid';
      initTronGrid();
    </script>
  </body>
</html>

<style>
  /* Tron Grid Canvas */
  .tron-grid-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
  }

  /* Scanlines effect */
  .scanlines {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: repeating-linear-gradient(
      0deg,
      rgba(0, 0, 0, 0.15),
      rgba(0, 0, 0, 0.15) 1px,
      transparent 1px,
      transparent 2px
    );
    pointer-events: none;
    z-index: 9999;
    opacity: 0.3;
  }

  /* Header */
  .header-tron {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(180deg, rgba(13, 18, 33, 0.95) 0%, rgba(10, 14, 26, 0.98) 100%);
    border-bottom: 2px solid var(--cyan-neon);
    box-shadow: 0 0 20px var(--cyan-glow);
    z-index: 1000;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
  }

  .header-tron.scrolled {
    box-shadow: 0 0 30px var(--cyan-glow), 0 5px 20px rgba(0, 0, 0, 0.5);
    background: linear-gradient(180deg, rgba(13, 18, 33, 0.98) 0%, rgba(10, 14, 26, 0.99) 100%);
  }

  .header-glow {
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg,
      transparent,
      var(--cyan-neon) 20%,
      var(--cyan-neon) 80%,
      transparent
    );
    filter: blur(3px);
  }

  .nav-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0.75rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    transition: all 0.3s ease;
  }

  .header-tron.scrolled .nav-container {
    padding: 0.5rem 2rem;
  }

  .logo {
    font-family: var(--font-primary);
    font-size: 1.5rem;
    font-weight: 700;
    color: #008B9E;
    text-shadow: 0 0 15px rgba(0, 139, 158, 0.6);
    letter-spacing: 0.1em;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
  }

  .logo:hover {
    color: #00a8bf;
    text-shadow: 0 0 20px rgba(0, 168, 191, 0.7);
  }

  .header-tron.scrolled .logo {
    font-size: 1.15rem;
  }

  /* $ y {} - ocultos por defecto */
  .logo-dollar,
  .logo-bracket-left,
  .logo-bracket-right {
    color: var(--orange-accent);
    font-weight: 900;
    opacity: 0;
    transform: scaleX(0);
    display: inline-block;
    transform-origin: center;
    transition: all 0.3s ease;
  }

  /* Animación en hover */
  .logo:hover .logo-dollar {
    opacity: 1;
    transform: scaleX(1);
    margin-right: 0.1rem;
  }

  .logo:hover .logo-bracket-left,
  .logo:hover .logo-bracket-right {
    opacity: 1;
    transform: scaleX(1);
  }

  .logo-text {
    transition: all 0.4s ease;
  }

  .nav-links {
    display: flex;
    gap: 2.5rem;
  }

  .nav-link {
    font-family: var(--font-primary);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
    letter-spacing: 0.15em;
    position: relative;
    padding: 0.5rem 0;
    transition: all 0.3s ease;
  }

  .header-tron.scrolled .nav-link {
    font-size: 0.8rem;
    padding: 0.35rem 0;
  }

  .nav-link::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: var(--cyan-neon);
    box-shadow: 0 0 10px var(--cyan-neon);
    transition: width 0.3s ease;
  }

  .nav-link:hover {
    color: #00a8bf;
    text-shadow: 0 0 10px rgba(0, 168, 191, 0.6);
  }

  .nav-link:hover::before {
    width: 100%;
  }

  /* Controls Grid - Agrupa Language Switcher y Theme Switch */
  .controls-grid {
    display: grid;
    grid-template-columns: auto auto;
    gap: 1rem;
    align-items: center;
  }

  /* Theme Switch estilo iPhone */
  .theme-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 30px;
    margin-left: 0;
  }

  .theme-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 107, 125, 0.3);
    border: 2px solid #006B7D;
    transition: all 0.4s ease;
    border-radius: 30px;
    box-shadow: 0 0 8px rgba(0, 107, 125, 0.4);
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 2px;
    bottom: 2px;
    background: #008B9E;
    transition: all 0.4s ease;
    border-radius: 50%;
    box-shadow: 0 0 10px rgba(0, 139, 158, 0.6);
  }

  input:checked + .slider {
    background: #006B7D;
    box-shadow: 0 0 15px rgba(0, 107, 125, 0.5);
  }

  input:checked + .slider:before {
    transform: translateX(30px);
    background: var(--bg-primary);
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
  }

  .slider:hover {
    box-shadow: 0 0 20px rgba(0, 107, 125, 0.6);
    border-color: #008B9E;
  }

  /* Light Mode */
  :root.light-mode {
    --bg-primary: #f5f5f5;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e8e8e8;
    --text-primary: #1a1a1a;
    --text-secondary: #333333;
    --text-muted: #666666;
    --cyan-neon: #0099cc;
    --cyan-bright: #00aadd;
    --cyan-glow: rgba(0, 153, 204, 0.4);
    --orange-accent: #ff6b35;
    --orange-glow: rgba(255, 107, 53, 0.4);
    --border-glow: rgba(0, 153, 204, 0.3);
    --grid-line: rgba(0, 153, 204, 0.2);
  }

  :root.light-mode .header-tron {
    background: linear-gradient(180deg, rgba(245, 245, 245, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);
    border-bottom: 2px solid var(--cyan-neon);
  }

  :root.light-mode .footer-tron {
    background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
  }

  :root.light-mode .scanlines {
    opacity: 0.05;
  }

  /* Ajustes para imágenes en modo claro */
  :root.light-mode .carousel-overlay {
    background: linear-gradient(180deg,
      rgba(245, 245, 245, 0.1) 0%,
      rgba(245, 245, 245, 0.2) 70%,
      rgba(245, 245, 245, 0.9) 100%
    );
  }

  :root.light-mode .carousel-overlay-hover {
    background: linear-gradient(180deg,
      rgba(245, 245, 245, 0.75) 0%,
      rgba(245, 245, 245, 0.85) 50%,
      rgba(245, 245, 245, 0.95) 100%
    );
  }

  :root.light-mode .card-image-overlay {
    background: linear-gradient(180deg,
      rgba(245, 245, 245, 0.1) 0%,
      rgba(245, 245, 245, 0.2) 70%,
      rgba(245, 245, 245, 0.85) 100%
    );
  }

  :root.light-mode .card-image-overlay-hover {
    background: linear-gradient(180deg,
      rgba(245, 245, 245, 0.75) 0%,
      rgba(245, 245, 245, 0.85) 50%,
      rgba(245, 245, 245, 0.95) 100%
    );
  }

  :root.light-mode .post-image-overlay {
    background: linear-gradient(180deg,
      rgba(245, 245, 245, 0.1) 0%,
      rgba(245, 245, 245, 0.3) 30%,
      rgba(245, 245, 245, 0.6) 60%,
      rgba(245, 245, 245, 0.85) 100%
    );
  }

  :root.light-mode .post-image-overlay-hover {
    background: linear-gradient(180deg,
      rgba(245, 245, 245, 0.75) 0%,
      rgba(245, 245, 245, 0.85) 50%,
      rgba(245, 245, 245, 0.95) 100%
    );
  }

  /* Texto blanco en modo claro para títulos pequeños (sin hover) */
  :root.light-mode .carousel-title-small .carousel-title,
  :root.light-mode .card-title-small .card-title,
  :root.light-mode .post-title-small .post-title {
    color: #ffffff !important;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
  }

  /* Texto blanco en modo claro para contenido completo (con hover) */
  :root.light-mode .carousel-description,
  :root.light-mode .card-description,
  :root.light-mode .post-description {
    color: #ffffff !important;
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.3) !important;
  }

  :root.light-mode .carousel-date,
  :root.light-mode .card-date,
  :root.light-mode .post-date {
    color: #e0e0e0 !important;
  }

  :root.light-mode .carousel-category,
  :root.light-mode .card-category {
    text-shadow: 0 0 10px currentColor !important;
  }

  /* Main content */
  .main-content {
    position: relative;
    z-index: 10;
    max-width: 1200px;
    margin: 0 auto;
    padding: 3rem 2rem;
    padding-top: calc(3rem + 90px); /* 90px es aprox la altura del header */
    min-height: calc(100vh - 250px);
  }

  /* Footer */
  .footer-tron {
    position: relative;
    z-index: 10;
    background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    border-top: 2px solid var(--cyan-neon);
    box-shadow: 0 0 20px var(--cyan-glow);
    margin-top: 4rem;
  }

  .footer-line {
    position: absolute;
    top: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg,
      transparent,
      var(--cyan-neon) 20%,
      var(--cyan-neon) 80%,
      transparent
    );
    filter: blur(3px);
  }

  .footer-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
    text-align: center;
  }

  .footer-text {
    font-family: var(--font-primary);
    font-size: 0.875rem;
    color: var(--text-secondary);
    letter-spacing: 0.1em;
    margin-bottom: 0.5rem;
  }

  .footer-bracket {
    color: var(--cyan-neon);
    font-weight: 700;
    margin: 0 0.5rem;
  }

  .footer-dot {
    color: var(--orange-accent);
    margin: 0 0.75rem;
  }

  .footer-subtext {
    font-size: 0.75rem;
    color: var(--text-muted);
    letter-spacing: 0.2em;
  }

  /* Hamburger button - Solo móvil */
  .hamburger {
    display: none;
    flex-direction: column;
    gap: 5px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    z-index: 1001;
  }

  .hamburger-line {
    width: 25px;
    height: 2px;
    background: var(--cyan-neon);
    transition: all 0.3s ease;
    box-shadow: 0 0 5px var(--cyan-glow);
  }

  .hamburger.active .hamburger-line:nth-child(1) {
    transform: rotate(45deg) translate(7px, 7px);
  }

  .hamburger.active .hamburger-line:nth-child(2) {
    opacity: 0;
  }

  .hamburger.active .hamburger-line:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -7px);
  }

  /* Mobile Menu */
  .mobile-menu {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(10, 14, 26, 0.98);
    backdrop-filter: blur(10px);
    z-index: 999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .mobile-menu.active {
    opacity: 1;
    pointer-events: all;
  }

  .mobile-menu-content {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    align-items: center;
  }

  .mobile-link {
    font-family: var(--font-primary);
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-decoration: none;
    letter-spacing: 0.15em;
    transition: all 0.3s ease;
    position: relative;
  }

  .mobile-link::before {
    content: '> ';
    opacity: 0;
    margin-right: 0;
    transition: all 0.3s ease;
    color: var(--cyan-neon);
  }

  .mobile-link:hover {
    color: var(--cyan-neon);
    text-shadow: 0 0 15px var(--cyan-glow);
    transform: translateX(10px);
  }

  .mobile-link:hover::before {
    opacity: 1;
    margin-right: 0.5rem;
  }

  .mobile-controls-wrapper {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid rgba(0, 107, 125, 0.3);
    width: 100%;
  }

  .mobile-lang-switch {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
  }

  .lang-label {
    font-family: var(--font-primary);
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-secondary);
    letter-spacing: 0.15em;
  }

  .mobile-theme-switch {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
  }

  .theme-label {
    font-family: var(--font-primary);
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-secondary);
    letter-spacing: 0.15em;
  }

  .mobile-theme-switch .theme-switch {
    margin-left: 0;
  }

  /* Prevenir scroll cuando menu está abierto */
  body.menu-open {
    overflow: hidden;
  }

  /* Responsive - Móvil */
  @media (max-width: 768px) {
    .nav-container {
      max-width: 100%;
      padding: 0.75rem 1.5rem;
    }

    .hamburger {
      display: flex;
    }

    .nav-links {
      display: none;
    }

    .controls-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
      width: 100%;
      justify-items: center;
    }

    .main-content {
      padding: 2rem 1.5rem;
      padding-top: calc(2rem + 70px);
    }

    .logo {
      font-size: 1.25rem;
    }
  }
</style>
